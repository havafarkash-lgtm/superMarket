<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×¨×©×™××ª ×§× ×™×•×ª LIVE ğŸ”´</title>
    <style>
        :root { --primary: #4caf50; --accent: #2196f3; --danger: #f44336; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 80px; color: #333; -webkit-user-select: none; user-select: none; }
        
        /* × ×™×•×•×˜ ×•×¢×™×¦×•×‘ ×›×œ×œ×™ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-btn { border: none; background: none; font-size: 1.1em; font-weight: bold; color: #777; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: var(--primary); }
        .container { padding: 15px; display: none; }
        .container.active { display: block; }
        h2 { margin-top: 0; color: #333; }
        
        /* ×¨×©×™××•×ª ×•×¤×¨×™×˜×™× */
        .category-header { background-color: #e9ecef; padding: 8px 12px; border-radius: 6px; margin-top: 20px; font-weight: bold; color: #495057; display: flex; justify-content: space-between; }
        .item-row { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 12px; margin-bottom: 8px; border-radius: 8px; border-bottom: 1px solid #eee; }
        
        /* ××œ×× ×˜×™× ×œ×—×™×¦×™× */
        .item-name { font-size: 1.1em; flex-grow: 1; padding: 10px 0; cursor: context-menu; }
        .cat-name-display { font-weight: bold; flex-grow: 1; padding: 10px 0; cursor: context-menu; }

        .controls { display: flex; align-items: center; gap: 10px; }
        .circle-btn { width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 1.2em; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-minus { background: #ffebee; color: var(--danger); }
        .btn-plus { background: #e8f5e9; color: var(--primary); }
        .count-badge { font-weight: bold; min-width: 20px; text-align: center; }
        .shopping-item { cursor: pointer; transition: all 0.3s ease; }
        .shopping-item.checked { background-color: #f0f0f0; color: #aaa; text-decoration: line-through; opacity: 0.6; }
        .add-panel { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex-grow: 1; }
        .btn-add { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }
        .cat-manager-row { display: flex; justify-content: space-between; padding: 10px; background: white; border-bottom: 1px solid #eee; align-items: center; }
        .move-btn { background: none; border: none; font-size: 1.2em; }
        .empty-state { text-align: center; color: #888; margin-top: 50px; }
        
        /* ×¡×˜×˜×•×¡ ×˜×¢×™× ×” */
        #loading {
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8em;
            opacity: 0; transition: opacity 0.3s; z-index: 200; pointer-events: none;
        }

        /* --- ×—×œ×•×Ÿ ×§×•×¤×¥ (Modal) --- */
        .modal {
            display: none; 
            position: fixed; z-index: 500; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; padding: 20px; border-radius: 12px; width: 80%; max-width: 300px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .modal h3 { margin-top: 0; color: var(--primary); }
        .modal-btn {
            display: block; width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px;
            font-size: 1em; font-weight: bold; cursor: pointer;
        }
        .btn-edit { background-color: var(--accent); color: white; }
        .btn-delete { background-color: var(--danger); color: white; }
        .btn-cancel { background-color: #eee; color: #333; }

    </style>
</head>
<body>

    <div id="loading">×˜×•×¢×Ÿ...</div>

    <div id="options-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">××¤×©×¨×•×™×•×ª</h3>
            <p id="modal-item-name" style="color:#666; margin-bottom:20px;"></p>
            <button class="modal-btn btn-edit" onclick="handleEdit()">âœï¸ ×¢×¨×•×š ×©×</button>
            <button class="modal-btn btn-delete" onclick="handleDelete()">ğŸ—‘ï¸ ××—×§</button>
            <button class="modal-btn btn-cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <div id="view-planning" class="container active">
        <div class="add-panel">
            <h3>×”×•×¡×¤×ª ××•×¦×¨</h3>
            <div class="input-group">
                <input type="text" id="new-item-name" placeholder="×©× ×”××•×¦×¨">
            </div>
            <div class="input-group">
                <select id="new-item-category"></select>
            </div>
            <button class="btn-add" onclick="addNewItem()">×”×•×¡×£ ×œ×¨×©×™××”</button>
        </div>

        <button onclick="toggleCategoryManager()" style="background:none; border:none; color: #777; text-decoration: underline; margin-bottom: 10px;">× ×™×”×•×œ ×¡×“×¨ ××¢×‘×¨×™×</button>
        
        <div id="category-manager" style="display:none; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 8px;">
            <div style="font-size:0.8em; color:#999; text-align:center; margin-bottom:10px;">
                ×œ×—×™×¦×” ××¨×•×›×” ×¢×œ ×©× ×§×˜×’×•×¨×™×” ×œ×¢×¨×™×›×”/××—×™×§×”
            </div>
            <div id="cat-order-list"></div>
            <div class="input-group" style="margin-top:10px;">
                <input type="text" id="new-cat-name" placeholder="×§×˜×’×•×¨×™×” ×—×“×©×”">
                <button class="btn-add" style="width:auto;" onclick="addNewCategory()">×”×•×¡×£</button>
            </div>
        </div>

        <div style="font-size:0.8em; color:#999; text-align:center; margin-bottom:10px;">
            ğŸ’¡ ×˜×™×¤: ×œ×—×™×¦×” ××¨×•×›×” ×¢×œ ×©× ××•×¦×¨ ×¤×•×ª×—×ª ××¤×©×¨×•×™×•×ª
        </div>

        <div id="planning-list"></div>
    </div>

    <div id="view-shopping" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ğŸ›’ ×¢×’×œ×”</h2>
            <button onclick="fetchData()" style="font-size:0.9em; background:#eee; border:none; padding:5px 10px; border-radius:5px;">ğŸ”„ ×¨×¢× ×Ÿ ×›×¢×ª</button>
        </div>
        <div style="text-align: left; margin-bottom: 10px;">
            <button onclick="clearBought()" style="color: var(--danger); background: none; border: 1px solid var(--danger); padding: 5px 10px; border-radius: 4px;">× ×§×” ××¡×•×× ×™×</button>
        </div>
        <div id="shopping-list"></div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('planning')" id="nav-planning">ğŸ“ ×ª×›× ×•×Ÿ</button>
        <button class="nav-btn" onclick="switchTab('shopping')" id="nav-shopping">ğŸ›’ ×‘×¡×•×¤×¨</button>
    </div>

    <script>
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // ×”×“×‘×§ ×›××Ÿ ××ª ×”×›×ª×•×‘×ª ×©×œ×š ××’×•×’×œ Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDJQJ5KcE5u6HOwyb2a1aSkTLR9hO29KUbBSc3dgk08v5QWUwjcRvNVAmVxxlUA0ebog/exec"; 
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        let appData = {
            categories: ["×™×¨×§×•×ª ×•×¤×™×¨×•×ª", "×××¤×™×", "××•×¦×¨×™ ×—×œ×‘", "×™×‘×©×™×", "× ×™×§×™×•×Ÿ"],
            items: []
        };

        // ××©×ª× ×™× ×œ× ×™×”×•×œ ×¢×¨×™×›×”/××—×™×§×” (×ª×•××š ×’× ×‘××•×¦×¨×™× ×•×’× ×‘×§×˜×’×•×¨×™×•×ª)
        let editTarget = null; // ×™×—×–×™×§ ××•×‘×™×™×§×˜: { type: 'item'/'cat', id: ..., index: ... }
        let isUserTyping = false;
        let saveTimeout = null;

        
        document.addEventListener('input', (e) => { 
            if(e.target.tagName === 'INPUT') {
                isUserTyping = true; 
                setTimeout(() => isUserTyping = false, 5000); 
            }
        });

        function showLoading(show) {
            const el = document.getElementById('loading');
            el.style.opacity = show ? 1 : 0;
            el.innerText = show ? "×©×•××¨..." : "";
        }

        async function fetchData(isBackground = false) {
            if (!isBackground) showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                const newData = await response.json();
                
                if (newData && newData.categories) {
                    if (JSON.stringify(newData) !== JSON.stringify(appData)) {
                        if (!isUserTyping && document.getElementById('options-modal').style.display !== 'flex') {
                            appData = newData;
                            renderAll();
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading data:", error);
            }
            if (!isBackground) showLoading(false);
        }

        async function saveData() {
    // ×¨×™× ×“×•×¨ ××™×™×“×™
    renderAll();

    // ×‘×™×˜×•×œ ×©××™×¨×” ×§×•×“××ª ×× ×§×™×™××ª
    if (saveTimeout) {
        clearTimeout(saveTimeout);
    }

    // ×©××™×¨×” ×œ×©×¨×ª ×¨×§ ××—×¨×™ ×©×”××©×ª××© ×”×¤×¡×™×§ ×œ×œ×—×•×¥
    saveTimeout = setTimeout(() => {
        showLoading(true);
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(appData)
        }).finally(() => {
            showLoading(false);
        });
    }, 500);
}



        function init() { 
            fetchData();
            setInterval(() => { fetchData(true); }, 1000);
        }

        // --- ×œ×•×’×™×§×” ×—×›××” ×œ× ×™×”×•×œ ××•×“×œ (×¢×¨×™×›×”/××—×™×§×”) ---

        // ×¤×ª×™×—×ª ××•×“×œ ×œ××•×¦×¨
        function openItemModal(id, name) {
            editTarget = { type: 'item', id: id };
            document.getElementById('modal-title').innerText = "×¢×¨×™×›×ª ××•×¦×¨";
            document.getElementById('modal-item-name').innerText = name;
            document.getElementById('options-modal').style.display = 'flex';
        }

        // ×¤×ª×™×—×ª ××•×“×œ ×œ×§×˜×’×•×¨×™×”
        function openCategoryModal(index, name) {
            editTarget = { type: 'cat', index: index };
            document.getElementById('modal-title').innerText = "×¢×¨×™×›×ª ×§×˜×’×•×¨×™×”";
            document.getElementById('modal-item-name').innerText = name;
            document.getElementById('options-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('options-modal').style.display = 'none';
            editTarget = null;
        }

        function handleEdit() {
            if (!editTarget) return;

            // ×¢×¨×™×›×ª ××•×¦×¨
            if (editTarget.type === 'item') {
                const item = appData.items.find(i => i.id === editTarget.id);
                if (item) {
                    const newName = prompt("×”×›× ×¡ ×©× ××•×¦×¨ ×—×“×©:", item.name);
                    if (newName && newName.trim() !== "") {
                        item.name = newName.trim();
                        saveData();
                    }
                }
            }
            // ×¢×¨×™×›×ª ×§×˜×’×•×¨×™×”
            else if (editTarget.type === 'cat') {
                const oldName = appData.categories[editTarget.index];
                const newName = prompt("×”×›× ×¡ ×©× ×§×˜×’×•×¨×™×” ×—×“×©:", oldName);
                if (newName && newName.trim() !== "") {
                    // ×¢×“×›×•×Ÿ ×”××¢×¨×š
                    appData.categories[editTarget.index] = newName.trim();
                    // ××•×¤×¦×™×•× ×œ×™: ×œ×¢×“×›×Ÿ ×’× ××ª ×›×œ ×”××•×¦×¨×™× ×©××©×•×™×›×™× ×œ×©× ×”×™×©×Ÿ?
                    // ×›×¨×’×¢ × ×©××™×¨ ×¤×©×•×˜, ×”××©×ª××© ×™×›×•×œ ×œ×©× ×•×ª ×™×“× ×™×ª ×× ×¦×¨×™×š
                    saveData();
                }
            }
            closeModal();
        }

        function handleDelete() {
            if (!editTarget) return;

            // ××—×™×§×ª ××•×¦×¨
            if (editTarget.type === 'item') {
                if (confirm("×œ××—×•×§ ××ª ×”××•×¦×¨ ×œ×¦××™×ª×•×ª?")) {
                    appData.items = appData.items.filter(i => i.id !== editTarget.id);
                    saveData();
                }
            }
            // ××—×™×§×ª ×§×˜×’×•×¨×™×”
            else if (editTarget.type === 'cat') {
                if (confirm("×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×”? (××•×¦×¨×™× ×‘×ª×•×›×” ×™×•×¡×ª×¨×• ×¢×“ ×©×ª×™×¦×•×¨ ××•×ª×” ××—×“×©)")) {
                    appData.categories.splice(editTarget.index, 1);
                    saveData();
                }
            }
            closeModal();
        }

        // --- ×œ×•×’×™×§×” ×¨×’×™×œ×” ---

        function addNewItem() {
            const nameInput = document.getElementById('new-item-name');
            const catSelect = document.getElementById('new-item-category');
            const name = nameInput.value.trim();
            if (!name) return;
            appData.items.push({ id: Date.now(), name: name, cat: catSelect.value, count: 1, checked: false });
            nameInput.value = '';
            isUserTyping = false;
            saveData();
        }

     function updateCount(id, change) {
    isUserTyping = true;
    setTimeout(() => isUserTyping = false, 1000);

    const item = appData.items.find(i => i.id === id);
    if (item) {
        item.count += change;
        if (item.count < 0) item.count = 0;
        if (item.count > 0) item.checked = false;
        saveData();
    }
}


        function toggleCheck(id) {
            const item = appData.items.find(i => i.id === id);
            if (item) { item.checked = !item.checked; saveData(); }
        }

        function clearBought() {
            if(confirm("×œ××—×•×§ ××¡×•×× ×™×?")) {
                appData.items.forEach(item => { if (item.checked) { item.count = 0; item.checked = false; } });
                saveData();
            }
        }
        
        function addNewCategory() {
            const input = document.getElementById('new-cat-name');
            const name = input.value.trim();
            if(name && !appData.categories.includes(name)) {
                appData.categories.push(name);
                input.value = '';
                saveData();
            }
        }

        function moveCategory(index, direction) {
            if (direction === -1 && index > 0) {
                [appData.categories[index], appData.categories[index-1]] = [appData.categories[index-1], appData.categories[index]];
            } else if (direction === 1 && index < appData.categories.length - 1) {
                [appData.categories[index], appData.categories[index+1]] = [appData.categories[index+1], appData.categories[index]];
            }
            saveData();
        }

        // --- ×ª×¦×•×’×” ---

        function renderAll() {
            renderPlanning(); renderShopping(); updateCategorySelect(); renderCategoryManager();
        }

        function renderPlanning() {
            const container = document.getElementById('planning-list');
            container.innerHTML = '';
            appData.categories.forEach(cat => {
                const itemsInCat = appData.items.filter(i => i.cat === cat);
                if(itemsInCat.length > 0) {
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.innerText = cat;
                    container.appendChild(header);
                    itemsInCat.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'item-row';
                        div.style.background = item.count > 0 ? '#e8f5e9' : 'white';
                        
                        div.innerHTML = `
                            <span class="item-name" oncontextmenu="event.preventDefault(); openItemModal(${item.id}, '${item.name.replace(/'/g, "\\'")}')">${item.name}</span>
                            <div class="controls">
                                <button class="circle-btn btn-minus" onclick="updateCount(${item.id}, -1)">âˆ’</button>
                                <span class="count-badge">${item.count > 0 ? item.count : ''}</span>
                                <button class="circle-btn btn-plus" onclick="updateCount(${item.id}, 1)">+</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            });
        }

        function renderShopping() {
            const container = document.getElementById('shopping-list');
            container.innerHTML = '';
            const toBuy = appData.items.filter(i => i.count > 0);
            if (toBuy.length === 0) {
                container.innerHTML = '<div class="empty-state">×¢×’×œ×” ×¨×™×§×”</div>';
                return;
            }
            appData.categories.forEach(cat => {
                const itemsInCat = toBuy.filter(i => i.cat === cat);
                if (itemsInCat.length > 0) {
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.innerText = cat;
                    container.appendChild(header);
                    itemsInCat.sort((a,b) => a.checked - b.checked);
                    itemsInCat.forEach(item => {
                        const div = document.createElement('div');
                        div.className = `item-row shopping-item ${item.checked ? 'checked' : ''}`;
                        div.onclick = () => toggleCheck(item.id);
                        div.innerHTML = `
                            <span class="item-name">${item.name}</span>
                            <div style="font-weight:bold; color:var(--primary);">${item.count}</div>
                        `;
                        container.appendChild(div);
                    });
                }
            });
        }

        function updateCategorySelect() {
            const select = document.getElementById('new-item-category');
            const currentSelection = select.value; 
            select.innerHTML = '';
            appData.categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                select.appendChild(opt);
            });
            if (currentSelection) select.value = currentSelection;
        }

        function renderCategoryManager() {
            const list = document.getElementById('cat-order-list');
            list.innerHTML = '';
            appData.categories.forEach((cat, index) => {
                const div = document.createElement('div');
                div.className = 'cat-manager-row';
                // ×”×•×¡×¤× ×• ×›××Ÿ ××ª ××™×¨×•×¢ ×”×œ×—×™×¦×” ×”××¨×•×›×” ×¢×œ ×”×§×˜×’×•×¨×™×”
                div.innerHTML = `
                    <span class="cat-name-display" oncontextmenu="event.preventDefault(); openCategoryModal(${index}, '${cat.replace(/'/g, "\\'")}')">${index + 1}. ${cat}</span>
                    <div>
                        <button class="move-btn" onclick="moveCategory(${index}, -1)">â¬†ï¸</button>
                        <button class="move-btn" onclick="moveCategory(${index}, 1)">â¬‡ï¸</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabName}`).classList.add('active');
            document.getElementById(`nav-${tabName}`).classList.add('active');
            if(tabName === 'shopping') fetchData(); 
        }

        function toggleCategoryManager() {
            const el = document.getElementById('category-manager');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // ×¡×’×™×¨×ª ××•×“×œ
        window.onclick = function(event) {
            const modal = document.getElementById('options-modal');
            if (event.target == modal) closeModal();
        }

        init();
    </script>
</body>
</html>





